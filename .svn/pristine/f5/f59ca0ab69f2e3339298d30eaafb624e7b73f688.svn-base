<meta name="_csrf" content="${_csrf.token}">
<meta name="_csrf_header" content="${_csrf.headerName}">
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
<sec:authentication property="principal.MemberVO" var="user" />
<script src="/resources/js/jquery-3.6.0.js"></script>
<script>
let bzentNo = "${user.bzentNo}";
let bzentType = "${bzentType}";
const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

// 추가된 상품 목록을 저장하는 배열
let gdsList = [];

$(function(){
	// 양식 다운로드 버튼 클릭
    $("#downloadTemp").on("click", function() {
        window.location.href = '/cnpt/stock/downloadTemp?bzentNo='+bzentNo;
    });
	
	// 추가버튼 이벤트 핸들러
	$("#insertNewGds").on("click", function(){
		// 입력한 값 가져오기
		let gdsCode = $("#gdsNm").val();
		let gdsNm = $("#gdsNm option:selected").text();
		let gdsType = $("#gdsType").val();
		let unitNm = $("#unitNm").val();
		let qty = $("#qty").val();
		let amt = $("#amt").val();
		let ntslType = $("#ntslType").val();
		
		// 필수 입력값 체크
		if(!gdsCode || !gdsType || !unitNm || !qty || !amt || !ntslType ){
			Swal.fire({
			      icon: 'error',
			      title: '필수 항목 입력 오류!',
			      text: '필수 입력 항목들을 모두 입력하세요.'
			});
			return;
		}
		
		// 데이터 객체 생성
		let gdsData = {
				gdsCode : gdsCode, 
				gdsNm : gdsNm,
				gdsType : gdsType,
				unitNm : unitNm,
				qty : qty,
				amt : amt,
				ntslType : ntslType,
				bzentNo : bzentNo
		};
		
		// 데이터 배열에 추가
		gdsList.push(gdsData);
		
		// 테이블에 행 추가
		$("#gds-list").append(`
				<tr>
					<td><button type="button" class="delete-btn">삭제</button></td>
					<td>${gdsNm}</td>
					<td>${gdsType}</td>
					<td>${unitNm}</td>
					<td>${qty}</td>
					<td>${ntslType}</td>
					<td>${amt}</td>
				</tr>
				`);
		// 입력한 값 초기화
		$(".input-reset").val("");
	// 추가버튼 이벤트 끝	
	});
	
	// 삭제버튼 클릭 시 이벤트 핸들러
	$(document).on("click", ".delete-btn", function(){
		let rowIndex = $(this).closet("tr").index();
		// 배열에서 삭제
		gdsList.splice(rowIndex, 1);
		// 테이블에서 삭제
		$(this).closet("tr").remove();
	
	// 삭제버튼 클릭 이벤트 끝	
	});
	
	// 저장 버튼 클릭시 이벤트 핸들러
	$("#gdsSaveBtn").on("click", function(){
		if(gdsList.length === 0){
			Swal.fire({
			      icon: 'error',
			      title: '추가 오류!',
			      text: '추가된 상품이 없습니다.'
			});
			return;
		}
		
		// 비동기 ajax요청
		$.ajax({
			url : '/cnpt/stock/insertNewAll',
			type : 'POST',
			contentType : 'application/json; charset=utf-8',
			data : JSON.stringify({'gdsList':gdsList}),
			beforeSend : function(xhr){
				xhr.setRequestHeader(csrfHeader, csrfToken);
			},
			success : function(res){
				Swal.fire({
				      icon: 'success',
				      title: '성 공!',
				      text: '상품 등록이 완료되었습니다.'
				    });
				// 성공시 페이지 리로드
				location.reload();
			},
			error : function(xhr, status, error){
				Swal.fire({
				      icon: 'error',
				      title: 'Error!',
				      text: '상품 등록에 실패하였습니다.'
				    });
			}
		
			
		// ajax 끝	
		});
	// 저장버튼 이벤트 핸들러 끝		
	});
	
	
});


</script>
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2 justify-content-between">
      <div class="row align-items-center">
        <h1 class="m-0">신규 기초 재고 등록</h1>
      </div><!-- /.col -->
      <div class="btn-wrap">
			<button class="btn-active" id="downloadTemp">양식
			<span class="material-symbols-outlined icon">download</span></button>
	 </div>
    </div><!-- /.row -->
  </div><!-- /.container-fluid -->
</div>

<div class="wrap">
	<div class="cont">
		
		<!-- table-wrap -->
		<div class="table-wrap">
			<table class="table-default">
				<tbody id="table-body" class="table-error">
					<tr>
						<td class="error-info" colspan="7">
							<span class="icon material-symbols-outlined">notifications_active</span>
							<div class="error-msg">
								<span class="material-symbols-outlined">arrow_right</span>
								상품의 기초 재고를 등록하는 페이지입니다.
							</div>
							<div class="error-msg">	
								<span class="material-symbols-outlined">arrow_right</span>
								* 표기된 항목은 필수입력 항목입니다.
							</div>	
						</td>
					</tr>
				</tbody>
			</table>
			<!-- table-wrap -->
		</div>
		<!-- cont 끝 -->
	</div>
	
		<div class="cont">
		<!-- table-wrap 가맹점 정보-->
		<div class="table-wrap" style="overflow-x: inherit !important;">
			<div class="table-title">
					<div class="cont-title"><span class="material-symbols-outlined title-icon">package_2</span>상품 정보</div> 
					<div class="btn-wrap">
						<button type="button" class="btn-active gds-qty" id="#insertNewGds">추가<span class="icon material-symbols-outlined">East</span></button>
					</div>
			</div>
			<table class="table-blue">
				<tr>
					<th>상품 명<span class="es gds-insert">*</span></th>
					<td style="width: 20%" class="gdsNm">
						<div class="select-custom" style="width:255px;">
							<select name="gdsNm" id="gdsNm" class="input-reset input-gds">
								<option value="" selected>선택해 주세요.</option>
								<c:forEach var="gdsVO" items="${gdsAllList}">
									<option value="${gdsVO.gdsCode}">${gdsVO.gdsNm}</option>
								</c:forEach>
							</select>
						</div>	
					</td>
					<th>상품 유형<span class="es gds-insert">*</span></th>
					<td style="width: 37%" class="gdsType">
						<div class="select-custom" style="width:200px;">
							<select name="gdsType" id="gdsType" class="input-reset input-gds">
								<option value="" selected>미선택</option>
								<c:if test="${bzentType == 'BZ_C01' }">
									<option value="FD01" class="fd">축산 </option>
									<option value="FD02" class="fd">농산물 </option>
									<option value="FD03" class="fd">유제품</option>
									<option value="FD04" class="fd">베이커리</option>
									<option value="FD05" class="fd">조미료/소스</option>
									<option value="FD06" class="fd">냉동식품</option>
									<option value="FD07" class="fd">기타</option>
								</c:if>
								<c:if test="${bzentType == 'BZ_C02' }">
									<option value="SM01" class="sm">매장 소모품</option>
									<option value="SM02" class="sm">조리 용품</option>
									<option value="SM03" class="sm">위생 용품</option>
								</c:if>
								<c:if test="${bzentType == 'BZ_C03' }">
									<option value="PM01" class="pm">일회 용품</option>
								</c:if>
							</select>
						</div>	
					</td>
				</tr>
				<tr>
					<th>단위<span class="es gds-insert">*</span></th>
					<td style="width: 50%" class="unitNm">
						<input id="unitNm" type="text" 
							   class="text-input input-reset input-gds" placeholder="단위를 입력하세요" />
					</td>
					<th>등록 일자<span class="es gds-insert">*</span></th>
					<td>
						<c:set var="now" value="<%=new java.util.Date()%>" />
					    <fmt:formatDate value="${now}" pattern="yyyy-MM-dd" />
					</td>
				</tr>
				<tr class="gds-dtl">
					<th>수량<span class="es gds-insert">*</span></th>
					<td>
						<input id="qty" type="text" 
							   class="text-input input-reset input-gds" placeholder="수량을 입력하세요" />
					</td>
					<th>판매 유형 <span class="es gds-insert">*</span></th>
					<td id="ntslTypeTd">
						<div class="select-custom ">
							<select name="ntslType" id="ntslType">
								<option value="" selected>선택해 주세요.</option>
								<option value="GDNT02">미판매</option>
								<option value="GDNT03">판매중</option>
							</select>
						</div>
					</td>
				</tr>
				<tr class="gds-dtl">
					<th>단가<span class="es gds-insert">*</span></th>
					<td>
						<input id="amt" type="text" 
							   class="text-input input-reset input-amt" placeholder="단가을 입력하세요" />
					</td>
				</tr>
			</table>
			<div></div>
		</div>
		<!-- /.table-wrap -->
	<!-- cont 끝 -->	
	</div>
	
		<div class="cont">
			<div class="table-wrap">
				<div class="table-title">
						<div class="cont-title"><span class="material-symbols-outlined title-icon">list_alt</span>구매 목록</div>
						<div class="btn-wrap">
							<button type="button" class="btn-active gds-qty" id="gdsSaveBtn">저장<span class="icon material-symbols-outlined">East</span></button>
						</div> 
				</div>
				<table class="table-blue gds-table">
				<thead>
					<tr>
						<th style="text-align:center; width: 7%;">삭제</th>
						<th style="text-align:center; width: 18%;">상품명</th>
						<th style="text-align:center; width: 12%;">상품유형</th>
						<th style="text-align:center; width: 9%;">단위</th>
						<th style="text-align:center; width: 18%;">등록일자</th>
						<th style="text-align:center; width: 11%;">수량</th>
						<th style="text-align:center; width: 11%;">판매유형</th>
						<th style="text-align:center; width: 13%;">단가</th>
					</tr>
				</thead>
				<tbody id="gds-list">
				</tbody>
				<tfoot>
					<tr>
						<th colspan="2" style="text-align:center; width: 20%;">총 상품 수</th>
						<td colspan="6"><span id="clclnAmt">0</span></td>
					</tr>
				</tfoot>
			</table>
			</div>
			<!-- /.table-wrap 관리자 정보 -->
		</div>
		<!-- /cont 발주 목록 -->
</div>	